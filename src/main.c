#include <eris/v810.h>
#include <eris/king.h>
#include <eris/tetsu.h>
#include <eris/romfont.h>
#include <eris/timer.h>
#include <eris/cd.h>
#include <eris/low/pad.h>
#include <eris/low/scsi.h>

#include <math.h>

#include "main.h"
#include "tinyfont.h"


#ifdef _8BPP
	unsigned char framebuffer[SCREEN_SIZE_IN_PIXELS];
#else
	unsigned short framebuffer[SCREEN_SIZE_IN_PIXELS];
#endif

static unsigned short myPal[256];


/*
static int ticks = 0;
static int prevT = 0;

static void initTimer()
{
	eris_timer_init();
	eris_timer_set_period(65535);
	eris_timer_start(0);
}

static void updateLameTimer()
{
	int t = eris_timer_read_counter();
	if (t > prevT) ticks++;
	prevT = t;
}

static void updateLameTimerSum()
{
	int t = eris_timer_read_counter();
	int dt = prevT - t;
	if (dt < 0) dt = 0;
	ticks += dt;
	prevT = t;
}

static void vsync()
{
	while(eris_tetsu_get_raster() !=200) {};
}
*/


static void initPal()
{
	int i;
	for (i=0; i<64; ++i) {
		myPal[i] = (i<<10) | (i<<0);
	}
	for (i=64; i<128; ++i) {
		myPal[i] = (255<<8) | (255 + 64 - i);
	}
	for (i=128; i<192; ++i) {
		myPal[i] = (255<<8) | (192 - 2*(i- 128));
	}
	for (i=192; i<256; ++i) {
		myPal[i] = ((255-i)<<10) | ((255-i)<<0);
	}
}

static void initDisplay()
{
	int i;
	u16 microprog[16];

	eris_king_init();
	eris_tetsu_init();

	eris_tetsu_set_priorities(0, 0, 1, 0, 0, 0, 0);
	eris_tetsu_set_king_palette(0, 0, 0, 0);
	eris_tetsu_set_rainbow_palette(0);

	eris_king_set_bg_prio(KING_BGPRIO_0, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, 0);
	#ifdef _8BPP
		eris_king_set_bg_mode(KING_BGMODE_256_PAL, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE);
	#else
		eris_king_set_bg_mode(KING_BGMODE_64K, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE);
	#endif
	eris_king_set_kram_pages(0, 0, 0, 0);

	for(i = 0; i < 16; i++) {
		microprog[i] = KING_CODE_NOP;
	}

	#ifdef _8BPP
		microprog[0] = KING_CODE_BG0_CG_0;
		microprog[1] = KING_CODE_BG0_CG_1;
		microprog[2] = KING_CODE_BG0_CG_2;
		microprog[3] = KING_CODE_BG0_CG_3;
	#else
		microprog[0] = KING_CODE_BG0_CG_0;
		microprog[1] = KING_CODE_BG0_CG_1;
		microprog[2] = KING_CODE_BG0_CG_2;
		microprog[3] = KING_CODE_BG0_CG_3;
		microprog[4] = KING_CODE_BG0_CG_4;
		microprog[5] = KING_CODE_BG0_CG_5;
		microprog[6] = KING_CODE_BG0_CG_6;
		microprog[7] = KING_CODE_BG0_CG_7;	
	#endif

	eris_king_disable_microprogram();
	eris_king_write_microprogram(microprog, 0, 16);
	eris_king_enable_microprogram();

	#ifdef _8BPP
	eris_tetsu_set_rainbow_palette(0);
	for(i = 0; i < 256; i++) {
		eris_tetsu_set_palette(i, myPal[i]);
	}
	#endif

	eris_tetsu_set_video_mode(TETSU_LINES_262, 0, TETSU_DOTCLOCK_5MHz, TETSU_COLORS_16, TETSU_COLORS_16, 0, 0, 1, 0, 0, 0, 0);

	eris_king_set_bat_cg_addr(KING_BG0, 0, 0);
	eris_king_set_bat_cg_addr(KING_BG0SUB, 0, 0);
	eris_king_set_scroll(KING_BG0, 0, 0);
	eris_king_set_bg_size(KING_BG0, KING_BGSIZE_256, KING_BGSIZE_256, KING_BGSIZE_256, KING_BGSIZE_256);

	eris_king_set_kram_read(0, 1);
	eris_king_set_kram_write(0, 1);

	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; ++i) {
		eris_king_kram_write(0);
	}
	eris_king_set_kram_write(0, 1);
}

void bufDisplay()
{
	int i;
	//unsigned int *dst = (unsigned int*)framebuffer;

	eris_king_set_kram_read(0, 1);
	eris_king_set_kram_write(0, 1);

	#ifdef _8BPP
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; i+=2) {
		eris_king_kram_write(framebuffer[i] << 8 | framebuffer[i+1]);
	}
	#else
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; ++i) {
		eris_king_kram_write(framebuffer[i]);
	}
	#endif

	/*#ifdef _8BPP
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; i+=4) {
		const unsigned int c = *dst++;
		const unsigned short c0 = (c << 8) | ((c>>8) & 0x00FF);
		const unsigned short c1 = ((c >> 8) & 0xFF00) | (c>>24);
		eris_king_kram_write(c0);
		eris_king_kram_write(c1);
	}
	#else
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; i+=2) {
		const unsigned int c = *dst++;
		const unsigned short c0 = (c << 8) | ((c>>8) & 0x00FF);
		const unsigned short c1 = ((c >> 8) & 0xFF00) | (c>>24);
		eris_king_kram_write(c0);
		eris_king_kram_write(c1);
	}
	#endif*/

	eris_king_set_kram_write(0, 1);
}

static void testDisplay(int t)
{
	int i;
	//int x,y;
	//unsigned int *dst = (unsigned int*)framebuffer;

	/*eris_king_set_kram_write(0, 1);
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; ++i) {
		eris_king_kram_write((unsigned short)(i+t));
	};*/

	int ii = t;
	for(i = 0; i < SCREEN_SIZE_IN_PIXELS; ++i) {
		framebuffer[i] = ii++;
	}

	/*i = 0;
	for (y=0; y<SCREEN_HEIGHT; ++y) {
		for (x=0; x<SCREEN_WIDTH; ++x) {
			framebuffer[i++] = x^y;
		}
	}*/
	/*for (y=0; y<SCREEN_HEIGHT; ++y) {
		framebuffer[y*SCREEN_WIDTH + y] = 0xFFFF;
	}*/

	bufDisplay();
}


#define NUM_SINES 4096

unsigned int fsin1_32[NUM_SINES/4] = {
1145192768,1229473605,1330531403,1414746704,1515738966,1600019547,1684169056,1751606885,1818978921,1886350957,1953722993,2004252021,2038003832,2088467322,2105376124,2138996350,
2139062143,2139062143,2139062143,2122284927,2105376382,2071755901,2038069883,1987541112,1937012086,1886483058,1819111023,1734961771,1667523942,1583308898,1499093853,1414878808,
1313886546,1229605709,1128547911,1027555393,943274556,842216758,741224241,656943659,572728358,488513313,404298524,336926231,269554195,202182159,151653132,101124104,
67437830,33751812,16843010,1,0,0,0,16843008,50528770,84214787,134678022,185207048,235736075,303108111,370480147,437852183,
522067228,606282273,707274534,791555115,892547632,976828214,1077820732,1178878785,1263159367,1364151885,1448432466,1532647767,1616862813,1701077858,1785227110,1852664939,
1903259759,1970566002,2021095030,2054846840,2088532859,2122153341,2139061886,2139062143,2139062143,2139062143,2122219391,2105376126,2071690364,2021227130,1970698104,1920169077,
1869574257,1785490798,1718052969,1633903717,1549688672,1465473627,1381193046,1280200529,1195919947,1094927429,993869376,909588794,808596276,724315439,623323177,539108132,
454893087,387455258,320083222,252711186,185339150,134810123,101058312,50594821,33686019,65793,0,0,0,16777216,33620225,67306242,
100992260,151521030,202050057,252579085,319951120,387323156,471538201,555752989,639968034,724183335,825175597,909456434,1010514232,1111506749,1195787331,1296845385,
1381060686,1482052948,1566333529,1650548574,1734698083,1802135912,1869507948,1936879984,1987409011,2037938038,2071624313,2105310331,2122219133,2139062142,2139062143,2139062143,
2139062143,2122219135,2088598909,2054912892,2004384121,1953855095,1903326068,1835954032,1768581996,1701209960,1616994915,1532779871,1448564826,1347572564,1263291727,1162233929,
1061241412,976960574,875902776,774910259,690629677,606414376,522199331,437984286,370612249,286397205,235868176,168496141,117967114,84215303,50529284,16908802,
257,0,0,0,16842752,33686017,67371779,117835013,151586823,218893066,269422350,336794129,421009173,488381210,572596255,673588516,
757869097,842084398,943142196,1044134713,1128415551,1229473349,1330465866,1414746448,1498961749,1599954011,1667391840,1751606885,1818978921,1886350957,1953722993,2004252020,
2038003831,2088467066,2105375868,2138996350,2139062143,2139062143,2139062143,2122284927,2105441918,2071755901,2038069883,2004318329,1937012086,1886483059,1819111023,1751738987,
1667523943,1583374690,1499159645,1414879064,1313886547,1229605965,1128613447,1044332610,943274812,842282294,758001457,657009195,572728614,488513569,421141276,336926231,
269554195,218959375,151653132,117901321,67437830,33751812,16843266,1,0,0,0,16843008,50463234,84149251,117900806,168429832,
235736075,303108111,370480147,437852183,522067227,606282016,690497317,791489579,875770160,976762678,1077820731,1162101313,1263093831,1347374668,1448366930,1532647511,
1616862812,1701077601,1768449894,1835821930,1903193966,1970566002,2021095029,2054781304,2088532859,2122153341,2139061886,2139062143,2139062143,2139062143,2122219391,2105376126,
2071690364,2021227130,1987475320,1920169077,1869640049,1802268014,1718053226,1650680933,1566465888,1482250843,1381258582,1296977745,1195919947,1094927430,1010646848,909588794,
808596277,724315695,640100394,555885348,471670303,387455259,320083222,252711186,202116366,134810123,101058312,67372293,33686275,16843009,0,0,
0,16777216,33620225,50529026,100992260,134743814,185272841,252579084,319951120,387323156,471537944,555687453,639902498,724183079,808398380,909456178,
1010448695,1094729277,1195787331,1296779848,1381060430,1465275731,1566267993,1650483038,1717920867,1802135655,1869507948,1920037232,1987409011,2021160822,2071624313,2105310331,
2122218877,2139062142,2139062143,2139062143,2139062143,2122219135,2088598909,2054912892,2021161338,1970632311,1903326068,1835954032,1768581996,1701209960,1616995172,1532780127,
1448565082,1347572565,1263291983,1162299466,1078018628,976960830,875968313,791687731,690695213,606414632,522199587,437984542,370612249,303240213,235868177,168496141,
134744330,84280839,50529284,16908802,257,0,0,0,16842752,33685761,67371779,101057797,151586823,218893066,269422093,336794129,
420943381,488381210,572596254,656811299,757803561,842084142,943076660,1027357497,1128415295,1229407813,1313688650,1414680912,1498961493,1583176794,1667391839,1751606628,
1818978921,1886350957,1936945777,2004252020,2038003831,2071689850,2105375868,2122219134,2139062143,2139062143,2139062143,2139062143,2105441918,2088533117,2038070139,2004318329,
1953789302,1886483059,1819111023,1751738987,1667589735,1600151906,1515936861,1414944600,1330664019,1229671501,1145390664,1044332866,943340348,859059511,758001713,673786412,
572794150,505356321,421141276,336992024,269554195,219025167,168430348,117901321,67437830,33751812,16843266,1,0,0,0,16843008,
50463234,84149251,117900805,168364296,235736075,286265103,370414354,437852183,522066971,606216480,690497061,774712362,875770160,976762677,1061043259,1162035777,
1263093830,1347374412,1448366929,1532581975,1616862556,1701012065,1768449894,1835821930,1903193966,1953788786,2004317813,2054781304,2088532859,2122153340,2139061886,2139062143,
2139062143,2139062143,2122219391,2105376382,2071690364,2038004346,1987540856,1936946293,1869640050,1802268014,1734895978,1650680933,1566466145,1482250844,1398035799,1296978001,
1195985484,1111704902,1010646848,909654331,825373749,724381231,640100650,555885349,471670304,387521051,320083222,252711186,202181902,151587339,101123848,67372293,
33686275,16843009,0,0,0,0,33620225,50528770,100992004,134678278,185207305,252579084,319951120,387323156,454695192,538910237,
623125282,724117543,808398124,909390641,993671223,1094729277,1195721794,1280002376,1380994894,1465275731,1549490776,1633705822,1717920867,1785292903,1852664939,1920036975,
1970631795,2021160822,2071624313,2105310331,2122218877,2139062142,2139062143,2139062143,2139062143,2122219135,2088598909,2054912892,2021161338,1970697847,1903326068,1852797041,
1785425005,1701209961,1617060708,1532845663,1448630618,1364350037,1263357519,1179076682,1078018884,977026367,892745529,791687731,707472430,606480168,522265123,454827294,
370612249,303240213,235868177,185273357,134744330,84280839,50594821,16908803,65793,0,0,0,16842752,33685761,67371779,101057797,
151521287,202050314,269422093,336794129,404166165,488381209,572595998,656811043,741026344,842018606,926299443,1027357241,1128349759,1212630596,1313688394,1414680911,
1498961493,1583176538,1667391583,1734763876,1818978921,1886350957,1936879985,1987474804,2037938295,2071689850,2105375868,2122219133,2139062143,2139062143,2139062143,2139062143,
2105441918,2088533373,2054847355,2004383865,1953854838,1886483059,1819111023,1751738987,1684366951,1600151907,1515936862,1431721817,1330664019,1246448718,1145390920,1044398402,
943340349,859059767,758067249,673786668,589571367,505356322,421141277,353769240,286397204,219025168,168430348,117966857,67438086,33751812,16843266,1,
0,0,0,16843008,50463233,84149251,117900805,168364296,218958859,286265102,353637138,437851926,505224219,589439264,690431525,774712106,
875704623,959985205,1060977723,1162035776,1246316358,1347308876,1431589713,1515804759,1616797020,1684234849,1768449893,1835821930,1903193966,1953723250,2004317813,2054781304,
2088467322,2122153340,2138996350,2139062143,2139062143,2139062143,2122284927,2105376382,2071755900,2038004347,1987540856,1937011829,1869640050,1802268014,1734895978,1650681190,
1566531681,1482251100,1398036055,1297043537,1212762956,1111704902,1010712385,926431803,825439285,741158448,640166186,555885605,471736096,404298267,320083479,252711186,
202182159,151587339,101123848,67372293,33686275,16843010,0,0,0,0,33620225,50528770,84214788,134678278,185207305,252579084,
303108111,387322899,454695192,538910236,623125025,707340326,808332588,892613425,993671223,1094663740,1178944578,1280002376,1364217677,1465275475,1549490520,1633705821,
1717920610,1785292903,1852664939,1920036975,1970566259,2021095286,2071624057,2088533115,2122218877,2139062142,2139062143,2139062143,2139062143,2122219135,2088598910,2054912892,
2021226874,1970698103,1920168820,1852797041,1785425005,1701275753,1633837924,1549622879,1465407834,1364350037,1280134736,1179076938,1078084421,993803583,892745785,791753268,
707472686,623257385,539042339,454827294,370612506,303240213,235868177,185339149,134809866,84280839,50594821,16908803,65793,0,0,0,
16777216,33685761,67306242,101057796,151521287,202050058,269422093,336794129,404166165,488315417,572530462,656745507,741026088,842018605,926299187,1027291705,
1111572542,1212630340,1313622858,1397903439,1498895957,1583111002,1667326047,1734763876,1802135912,1869507948,1936879984,1987409268,2037938295,2071689850,2105375868,2122219133,
2139062143,2139062143,2139062143,2139062143,2105441918,2088533373,2054847355,2004383865,1953855094,1903260275,1835954032,1768581996,1684366951,1600152163,1515937118,1431721817,
1330729555,1246448974,1145456456,1044398403,960117821,859125303,774844466,673852204,589571623,505356578,421207069,353769240,286397204,219025168,168495884,117966857,
84215302,50529028,16843266,257,0,0,0,16843008,50463233,84149251,117835269,168364040,218893323,286265102,353637138,421009174,
505224219,589439263,673654308,774646570,858927151,959919669,1060977722,1145258304,1246250822,1330531659,1431589457,1515804758,1600019803,1684234848,1768384101,1835821930,
1903193966,1953722993,2004252277,2054781048,2088467322,2105376124,2138996350,2139062143,2139062143,2139062143,2122284927,2105376382,2071755901,2038004347,1987541112,1937012085,
1869640050,1802268014,1734895978,1650746726,1583308897,1482316636,1398036055,1313820754,1212762956,1111770439,1027489857,926431803,825439286,741158704,656943403,555951141,
488513312,404298267,336926231,269554195,202182159,151652875,101123848,67372294,33686275,16843010,0,0,0,0,16843009,50528770,
84214788,134678278,185207049,235736332,303108111,370480147,454695191,538844444,623059489,707340070,791555371,892613169,993605686,1077886268,1178944322,1279936839,
1364217421,1465209939,1549424984,1633705565,1701077858,1785292903,1852664939,1920036975,1970566003,2021095286,2054846841,2088532859,2122218877,2139061886,2139062143,2139062143,
2139062143,2122219391,2088598910,2054913148,2021226874,1970698103,1920169076,1852797041,1785425005,1718052969,1633837925,1549623136,1465407835,1364415573,1280134992
};

static void testPlasma(int t)
{
	int x;
	int y = SCREEN_HEIGHT;
	unsigned char *fsy = (unsigned char*)fsin1_32;

	eris_king_set_kram_write(0, 1);

	while(y!=0) {
		const unsigned char yp = ((fsy[(y + 3*t) & (NUM_SINES-1)] + fsy[(3*y + 2*t) & (NUM_SINES-1)]) >> 1);
		const unsigned int ysin = (yp << 24) | (yp << 16) | (yp << 8) | yp;
		unsigned int *fs1 = (unsigned int*)fsin1_32;

		x = SCREEN_WIDTH >> 2;
		while(x!=0) {
			const unsigned int c = *fs1++ + ysin;
			const unsigned short c0 = (c << 8) | ((c>>8) & 0x00FF);
			const unsigned short c1 = ((c >> 8) & 0xFF00) | (c>>24);
			eris_king_kram_write(c0);
			eris_king_kram_write(c1);
			--x;
		}
		--y;
	}
}

int main()
{
	static int t = 0;
	//int t0, t1;

	initPal();
	initDisplay();

	initTinyFonts();

	//initTimer();
	
	for(;;) {
		testPlasma(t++);

		drawNumber(4,231-4, t);
	}

	return 0;
}
